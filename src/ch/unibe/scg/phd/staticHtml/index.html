<!DOCTYPE html>
<html lang="en" style="width: 100%; height: 100%;">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>&nbsp;</title>
<body style="width: 100%; height: 100%; margin-left: 0px;margin-top: 0px;margin-right: 0px;margin-bottom: 0px;">
<div id="wrapperDiv">
<canvas id="screenshotCanvas" style="width: 100%; height: 99.65%;"></canvas>
</div>

<script>
var canvas = document.getElementById("screenshotCanvas")
var wrapper = document.getElementById("wrapperDiv")
var socket = new WebSocket("ws://localhost:8081/screenshots");
var socketC = new WebSocket("ws://localhost:8081/control");
var timerDragDrop;
var mouseDown = false;
var activeDrag = false;

console.log("Dimension: " + window.innerWidth + "x" + window.innerHeight);

function updateLocalView() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    //console.log("Dimension change: " + window.innerWidth + "x" + window.innerHeight);
}
function updateView() {
    socket.send(window.innerWidth + "x" + window.innerHeight);
    //console.log("Requested screenshot. Dimension: " + window.innerWidth + "x" + window.innerHeight);
}
async function sleep(msec) {
    return new Promise(resolve => setTimeout(resolve, msec));
}

window.onresize = updateLocalView;

window.onload = function beginCommunication() {
    updateLocalView();

    socket.onopen = function(e) {
        updateView();
        var timer = setInterval(updateView, 2000);
    };
    socket.onmessage = function(event) {
        var blob = new Blob([event.data], {type: 'image/png'});
        var url = URL.createObjectURL(blob);
        var img = new Image;

        img.onload = function() {
            console.log("Received image. Dimensions: " + img.width + "x" + img.height)

            if (img.height > window.innerHeight) {
                canvas.style = "";
                canvas.height = img.height;
                canvas.width = window.innerWidth - 19; // Firefox scrollbar spacing magic number
            } else {
                canvas.style = "width: 100%; height: 99.65%;"
                canvas.height = window.innerHeight;
            }

            var ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            URL.revokeObjectURL(url);
        }
        img.src = url;
    };
    socketC.onmessage = function(event) {
        var msgType = event.data.substring(0, 1);
        var originalMessage = event.data.substring(2);
		
		switch (msgType) {
		case 'T': // title update
			console.log("Received title update: " + originalMessage);
            document.title = originalMessage;
			break;
		case 'P': // path update
            console.log("Received path update: " + originalMessage);
            if (originalMessage == "") {
                originalMessage = "/"; // needs that slash otherwise it won't work in Firefox
            }
            window.history.pushState("", "", originalMessage);
			break;
        case 'S': // scroll to top command
            console.log("Received scroll command.");
            window.scrollTo(0, 0);
			break;
        case 'C': // inject clickable
        var coordinateFragments = originalMessage.split("|");
        var location = coordinateFragments[0].split(",");
        var dimension = coordinateFragments[1].split(",");
        
            console.log("Received clickable.");
            /**var ctx = canvas.getContext('2d');
            ctx.beginPath();
            ctx.rect(location[0], location[1], dimension[0], dimension[1]);
            ctx.fillStyle = "red";
            ctx.fill();
            **/

            var htmlClickable = document.createElement("input");
            //var alreadyExistingClickables = this.filterClickables(currentClickables, point);

            //if (!alreadyExistingClickables || !alreadyExistingClickables.length) {
            htmlClickable.type = "button";
            htmlClickable.style.position = "absolute";
            htmlClickable.style.left = location[0] + 'px';
            htmlClickable.style.top = location[1] + 'px';
            htmlClickable.style.width = dimension[0] + 'px';
            htmlClickable.style.height = dimension[1] + 'px';
            htmlClickable.value = "";
            htmlClickable.style.cursor = "pointer";
            htmlClickable.style.background = "Transparent";
            htmlClickable.style.border = "none";
            htmlClickable.style.outline = "none";
            wrapper.appendChild(htmlClickable);
			break;
        }
    }

    document.onclick = async function(event) {
        socketC.send("C:" + event.pageX + "," + event.pageY);
        await sleep(300);
        updateView();
        await sleep(900);
        updateView();
    }
    /**document.oncontextmenu = async function(event) {
        // menu does not show up in screenshot
        console.log("Context click sent.");
        socketC.send("D:" + event.clientX + "," + event.clientY);
        await sleep(200);
        updateView();
        await sleep(500);
        updateView();
    }**/
    document.onkeypress = async function(event) {
        // this listener forwards all printable char codes (chars) to the server
        var charCode = event.charCode;
        event.preventDefault();
        event.stopPropagation();
        socketC.send("K:" + charCode);
        console.log("Sent key press code: " + charCode);
        await sleep(100);
        updateView();
        //await sleep(900);
        //updateView();
    };
    document.onkeydown = async function(event) {
        // this listener forwards major control key codes to the server
        var keyCode = event.keyCode;
        if (keyCode == 8 || keyCode == 9 || keyCode == 13 || keyCode == 27 || keyCode == 33 || keyCode == 34 || keyCode == 35 || keyCode == 36 || keyCode == 37 || keyCode == 38 || keyCode == 39 || keyCode == 40 || keyCode == 45 || keyCode == 46) { // these are control chars
            event.preventDefault();
            event.stopPropagation();
            socketC.send("L:" + keyCode);
            console.log("Sent key up code: " + keyCode);
            await sleep(300);
            updateView();
            await sleep(900);
            updateView();
        }
    }
    document.onmousemove = async function(event) { 
        // continuous mouse movement works but is way to slow for production
        // no view changes during drag, because only start and end point are set with no (human-like) points in between
        if (mouseDown && !activeDrag) {
            activeDrag = true;
            console.log("Mouse down sent.");
            socketC.send("X:" + event.clientX + "," + event.clientY);
        } else if (!mouseDown && activeDrag) {
            activeDrag = false;
            console.log("Mouse up sent.");
            socketC.send("Y:" + event.clientX + "," + event.clientY);
        }

        // code for continuous movement
        //console.log("Mouse movement: " + event.movementX + "," + event.movementY);
        //socketC.send("M:" + event.movementX + "," + event.movementY);
        //await sleep(500);
        //updateView();
    }
    document.onmousedown = async function(event) {
        mouseDown = true;
    }
    document.onmouseup = async function(event) {
        mouseDown = false;
    }
    /**window.addEventListener("hashchange", function(e) {
        console.log("back");
    })**/
}
</script>

</body>
</html> 
